# 安全的上下文输入验证

## 🔒 安全性改进

### 问题分析
之前的实现存在安全隐患：
- **任意字符串输入**：用户可以输入任何字符，包括特殊字符
- **负数处理不当**：-2、-10等负数没有明确的业务含义
- **输入验证宽松**：依赖用户理解"不限制"等中文字符串
- **潜在的解析错误**：parseInt可能产生意外结果

### 安全性要求
- **严格的数据类型**：只允许整数输入
- **明确的业务规则**：每个数值都有明确含义
- **防止注入攻击**：严格的输入格式验证
- **用户友好的错误提示**：清晰的错误信息

## 🛡️ 新的验证规则

### 允许的输入值
```typescript
-1    → 无限制上下文
0     → 无上下文（每次对话独立）
1     → 记住1条消息
2     → 记住2条消息
...   → 记住N条消息
```

### 拒绝的输入值
```typescript
-2, -3, -10  → 除-1外的负数（无业务含义）
1.5, 2.7     → 小数（不是整数）
abc, xyz     → 字母（非数字）
@#$%         → 特殊字符
空字符串      → 必须输入值
```

## 🔧 技术实现

### 严格的正则验证
```typescript
// 检查是否为纯数字（包括负号）
if (!/^-?\d+$/.test(trimmedInput)) {
  Alert.alert('错误', '只能输入整数，-1表示无限制，0或正整数表示具体条数');
  return;
}
```

**正则表达式说明：**
- `^`：字符串开始
- `-?`：可选的负号
- `\d+`：一个或多个数字
- `$`：字符串结束

### 分层验证逻辑
```typescript
const num = parseInt(trimmedInput);

if (num === -1) {
  // -1代表无限制
  contextLimit = undefined;
} else if (num >= 0) {
  // 0或正整数
  contextLimit = num;
} else {
  // 其他负数不允许
  Alert.alert('错误', '不支持除-1以外的负数，-1表示无限制');
  return;
}
```

### 输入框配置
```typescript
<TextInput
  keyboardType="numeric"           // 数字键盘
  placeholder="输入整数（-1表示无限制）"
  autoCapitalize="none"           // 禁用自动大写
  autoCorrect={false}             // 禁用自动纠错
/>
```

## ✅ 安全性提升

### 输入安全
- ✅ **格式验证**：严格的正则表达式验证
- ✅ **类型安全**：只接受整数类型
- ✅ **范围控制**：明确的数值范围规则
- ✅ **注入防护**：防止任意字符串注入

### 业务逻辑安全
- ✅ **语义明确**：每个数值都有明确的业务含义
- ✅ **边界处理**：-1作为特殊值处理无限制
- ✅ **错误处理**：完善的错误提示和处理
- ✅ **数据一致性**：确保存储的数据格式一致

### 用户体验安全
- ✅ **清晰提示**：明确的输入规则说明
- ✅ **即时反馈**：输入错误时立即提示
- ✅ **防误操作**：数字键盘减少误输入
- ✅ **一致性**：统一的输入验证标准

## 📊 验证测试用例

### 有效输入测试
```typescript
// 测试用例1：无限制
input: "-1"
expected: contextLimit = undefined
result: ✅ 通过

// 测试用例2：无上下文
input: "0"
expected: contextLimit = 0
result: ✅ 通过

// 测试用例3：正整数
input: "10"
expected: contextLimit = 10
result: ✅ 通过
```

### 无效输入测试
```typescript
// 测试用例4：其他负数
input: "-2"
expected: 错误提示
result: ✅ 拒绝

// 测试用例5：小数
input: "1.5"
expected: 错误提示
result: ✅ 拒绝

// 测试用例6：字母
input: "abc"
expected: 错误提示
result: ✅ 拒绝

// 测试用例7：空字符串
input: ""
expected: 错误提示
result: ✅ 拒绝
```

## 🎯 错误提示优化

### 分类错误信息
```typescript
// 空输入
"请输入上下文条数"

// 格式错误
"只能输入整数，-1表示无限制，0或正整数表示具体条数"

// 负数错误
"不支持除-1以外的负数，-1表示无限制"
```

### 用户指导
- **明确规则**：清楚说明什么是有效输入
- **示例说明**：提供具体的输入示例
- **错误原因**：解释为什么输入无效
- **解决方案**：告诉用户如何正确输入

## 🔍 代码审查要点

### 安全检查清单
- ✅ **输入验证**：是否有严格的格式验证
- ✅ **类型检查**：是否确保数据类型正确
- ✅ **边界处理**：是否处理了所有边界情况
- ✅ **错误处理**：是否有完善的错误处理机制
- ✅ **用户反馈**：是否提供了清晰的用户反馈

### 性能考虑
- **正则表达式**：简单高效的验证规则
- **parseInt优化**：在格式验证后使用，避免异常
- **错误处理**：早期返回，避免不必要的处理
- **内存安全**：避免字符串操作的内存泄漏

## 🚀 实际效果

### 用户操作流程
1. **打开设置**：看到数字输入框
2. **输入数值**：数字键盘，输入整数
3. **实时验证**：保存时进行严格验证
4. **错误提示**：无效输入时显示具体错误
5. **成功保存**：有效输入时正常保存

### 常用输入示例
- **0**：独立对话模式
- **3**：短期记忆模式
- **10**：一般对话模式
- **-1**：无限制模式

这个安全性改进大大提升了程序的健壮性，确保了数据的完整性和用户体验的一致性！🔒
